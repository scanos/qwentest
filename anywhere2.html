<!DOCTYPE html>
<html>
<head>
    <title>City Tourist Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 100vh; margin: 0; padding: 0; }
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Earth radius in miles
            const rlat1 = lat1 * Math.PI / 180;
            const rlat2 = lat2 * Math.PI / 180;
            const dlat = (lat2 - lat1) * Math.PI / 180;
            const dlon = (lon2 - lon1) * Math.PI / 180;

            const a = 
                Math.sin(dlat/2) * Math.sin(dlat/2) +
                Math.cos(rlat1) * Math.cos(rlat2) * 
                Math.sin(dlon/2) * Math.sin(dlon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function initMap() {
            try {
                // Get user's location
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                // Reverse geocode to get city name
                const reverseGeoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}`);
                const reverseGeoData = await reverseGeoResponse.json();
                const cityName = reverseGeoData.address.city || reverseGeoData.address.town || reverseGeoData.address.village;

                // Forward geocode to get city center
                const forwardGeoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityName)}`);
                const forwardGeoData = await forwardGeoResponse.json();
                const cityCenter = forwardGeoData.find(item => item.type === 'city') || forwardGeoData[0];
                const cityLat = parseFloat(cityCenter.lat);
                const cityLon = parseFloat(cityCenter.lon);

                // Get tourist attractions via Overpass
                const overpassQuery = `
                [out:json][timeout:25];
                area["name"="${cityName}"]->.searchArea;
                node["tourism"="attraction"](area.searchArea);
                out body;
                `;
                const overpassResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `data=${encodeURIComponent(overpassQuery)}`
                });
                const overpassData = await overpassResponse.json();

                // Process attractions
                const places = overpassData.elements.map(el => ({
                    name: el.tags.name || 'Unnamed Attraction',
                    lat: el.lat,
                    lon: el.lon,
                    distance: calculateDistance(cityLat, cityLon, el.lat, el.lon)
                }));

                // Sort and limit to 8
                places.sort((a, b) => a.distance - b.distance);
                const topPlaces = places.slice(0, 8);

                // Initialize map
                const map = L.map('map').setView([cityLat, cityLon], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // Add city marker
                L.marker([cityLat, cityLon]).addTo(map)
                    .bindPopup(`<b>${cityName}</b>`)
                    .openPopup();

                // Add attraction markers
                topPlaces.forEach(place => {
                    L.marker([place.lat, place.lon]).addTo(map)
                        .bindPopup(`<b>${place.name}</b><br>${place.distance.toFixed(2)} miles from city center`)
                        .openPopup();
                });

            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while loading the map. Please check the console for details.');
            }
        }

        document.addEventListener("DOMContentLoaded", initMap);
    </script>
</body>
</html>