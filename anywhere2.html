<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>City Attractions Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3958.8; // Radius of the Earth in miles
      const rlat1 = lat1 * Math.PI / 180;
      const rlat2 = lat2 * Math.PI / 180;
      const deltaLat = (lat2 - lat1) * Math.PI / 180;
      const deltaLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                Math.cos(rlat1) * Math.cos(rlat2) *
                Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function initMap(centerLat, centerLon, city, attractions) {
      const map = L.map('map').setView([centerLat, centerLon], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // City center marker
      L.marker([centerLat, centerLon])
        .addTo(map)
        .bindPopup(`<strong>${city}</strong> Center`)
        .openPopup();

      // Attraction markers
      attractions.forEach(attraction => {
        L.marker([attraction.lat, attraction.lon])
          .addTo(map)
          .bindPopup(`<strong>${attraction.name}</strong><br>${attraction.distance.toFixed(2)} miles from ${city}`);
      });
    }

    function fetchCityCenter(cityName, country, callback) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityName + ', ' + country)}&countrycodes=${country}&limit=1`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data && data[0]) {
            callback({
              lat: parseFloat(data[0].lat),
              lon: parseFloat(data[0].lon)
            });
          } else {
            console.error("City center not found");
          }
        })
        .catch(err => console.error("Error fetching city center:", err));
    }

    function fetchAttractions(cityName, country, cityCenter, callback) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=tourist+attractions+in+${encodeURIComponent(cityName)}&countrycodes=${country}&limit=20`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const attractions = [];

          data.forEach(item => {
            if (!item.display_name.toLowerCase().includes('hotel') && attractions.length < 8) {
              const lat = parseFloat(item.lat);
              const lon = parseFloat(item.lon);
              const distance = calculateDistance(cityCenter.lat, cityCenter.lon, lat, lon);

              attractions.push({
                name: item.display_name,
                lat: lat,
                lon: lon,
                distance: distance
              });
            }
          });

          callback(attractions);
        })
        .catch(err => console.error("Error fetching attractions:", err));
    }

    navigator.geolocation.getCurrentPosition(
      position => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}&zoom=10&addressdetails=1`;

        fetch(reverseUrl)
          .then(res => res.json())
          .then(reverseData => {
            const city = reverseData.address.city || reverseData.address.town || reverseData.address.village;
            const country = reverseData.address.country_code;

            if (!city) {
              alert("Could not determine city from your location.");
              return;
            }

            fetchCityCenter(city, country, cityCenter => {
              fetchAttractions(city, country, cityCenter, attractions => {
                initMap(cityCenter.lat, cityCenter.lon