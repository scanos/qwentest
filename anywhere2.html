<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OpenStreetMap Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .leaflet-popup-content-wrapper {
      font-family: Arial;
    }
    #selectBox {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      padding: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<select id="selectBox">
  <option value="">-- Select a category --</option>
  <option value="pub">Pub</option>
  <option value="shop">Shop</option>
  <option value="hotel">Accommodation</option>
  <option value="toilets">Toilet</option>
  <option value="tourist_attraction">Tourism</option>
  <option value="bus_station">Bus</option>
  <option value="subway">Metro</option>
</select>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Variables
let $mygps = null;
let $cityCenter = null;
let $city = "Unknown";
let map = L.map('map').setView([0, 0], 13);
let markersLayer = L.layerGroup().addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Step 1: Get user GPS
if ("geolocation" in navigator) {
  navigator.geolocation.getCurrentPosition(async function(position) {
    $mygps = [position.coords.latitude, position.coords.longitude];
    map.setView($mygps, 13);
    addMarker($mygps, 'You are here', 'blue');

    // Step 2: Reverse geocode to get city
    await reverseGeocode($mygps);
    if ($cityCenter && $city) {
      addMarker($cityCenter, `${$city} Center`, 'red');
      let dist = getDistance($mygps, $cityCenter).toFixed(1);
      document.body.innerHTML += `<div style="position: absolute; bottom: 10px; left: 10px; background: white; padding: 5px;">You are ${dist} km from ${$city}</div>`;
    }

  }, function(error) {
    alert("Error getting location");
  });
} else {
  alert("Geolocation not supported");
}

// Add marker
function addMarker(latlng, label, color='green') {
  let marker = L.marker(latlng, {
    icon: L.divIcon({ className: 'marker', html: `<div style="background:${color}; width:12px; height:12px; border-radius:50%;"></div>` })
  }).addTo(markersLayer)
    .bindPopup(label);
  return marker;
}

// Reverse geocode using Nominatim API
async function reverseGeocode(latlng) {
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng[0]}&lon=${latlng[1]}`);
  const data = await res.json();
  if (data.address.city || data.address.town || data.address.village) {
    $city = data.address.city || data.address.town || data.address.village;
    $cityCenter = [parseFloat(data.lat), parseFloat(data.lon)];
  }
}

// Handle dropdown change
document.getElementById('selectBox').addEventListener('change', async function() {
  let $dropdown = this.value;
  if (!$dropdown || !$mygps) return;

  // Clear previous markers
  markersLayer.clearLayers();

  // Re-add main markers
  addMarker($mygps, 'You are here', 'blue');
  if ($cityCenter) {
    addMarker($cityCenter, `${$city} Center`, 'red');
  }

  // Fetch places
  let $places = await getTopPOIs($dropdown, $mygps);
  console.log($places);

  $places.forEach(p => {
    let distFromCity = getDistance([$cityCenter[0], $cityCenter[1]], [p.lat, p.lon]).toFixed(1);
    let distFromUser = getDistance($mygps, [p.lat, p.lon]).toFixed(1);
    let popupContent = `<strong>${p.name}</strong><br>üìç ${distFromCity} km from city center<br>üö∂ ${distFromUser} km from you`;
    addMarker([p.lat, p.lon], popupContent);
  });
});

// Get Top 8 POIs near user using Overpass API
async function getTopPOIs(type, latlng) {
  const query = `
  [out:json][timeout:25];
  node["${type === 'hotel' ? 'tourism' : 'amenity'}"="${type}"](around:5000,${latlng[0]},${latlng[1]});
  out body;
  >;
  out skel qt;
  `;

  const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
  const res = await fetch(url);
  const data = await res.json();

  let places = [];
  for (let el of data.elements) {
    if (el.type === "node") {
      places.push({
        name: el.tags.name || "Unnamed",
        lat: el.lat,
        lon: el.lon
      });
    }
  }

  // Sort by proximity to user
  places.sort((a, b) => {
    let d1 = getDistance($mygps, [a.lat, a.lon]);
    let d2 = getDistance($mygps, [b.lat, b.lon]);
    return d1 - d2;
  });

  return places.slice(0, 8); // Limit to top 8
}

// Distance between two points in km
function getDistance([lat1, lon1], [lat2, lon2]) {
  const R = 6371; // Radius of earth in km
  const dLat = deg2rad(lat2 - lat1);
  const dLon = deg2rad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
function deg2rad(deg) {
  return deg * (Math.PI / 180);
}
</script>
</body>
</html>