<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OpenStreetMap Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    .leaflet-popup-content-wrapper {
      font-family: Arial;
    }
    #selectBox {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      padding: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<select id="selectBox"></select>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Variables
let $mygps = null;
let $cityCenter = null;
let $cityName = "Unknown";
let map = L.map('map').setView([0, 0], 13);
let markersLayer = L.layerGroup().addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Step 1: Get user GPS
if ("geolocation" in navigator) {
  navigator.geolocation.getCurrentPosition(async function(position) {
    $mygps = [position.coords.latitude, position.coords.longitude];
    map.setView($mygps, 13);
    addMarker($mygps, 'You are here', 'blue');

    // Step 2: Reverse geocode to get nearest city
    await reverseGeocode($mygps);
    if ($cityCenter && $cityName) {
      let dist = getDistance($mygps, $cityCenter).toFixed(1);
      addMarker($cityCenter, `${$cityName} Center`, 'red');
      showDistanceToCity(dist);
    }

    // Step 3: Populate dropdown (with optional translation)
    populateDropdown();

  }, function(error) {
    alert("Error getting location");
  });
} else {
  alert("Geolocation not supported");
}

// Show distance from city center
function showDistanceToCity(distance) {
  const info = document.createElement('div');
  info.style.position = 'absolute';
  info.style.bottom = '10px';
  info.style.left = '10px';
  info.style.background = '#fff';
  info.style.padding = '6px';
  info.innerHTML = `You are <strong>${distance}</strong> km from ${$cityName}`;
  document.body.appendChild(info);
}

// Add marker
function addMarker(latlng, label, color='green') {
  let marker = L.marker(latlng, {
    icon: L.divIcon({
      className: 'marker',
      html: `<div style="background:${color}; width:12px; height:12px; border-radius:50%;"></div>`
    })
  }).addTo(markersLayer).bindPopup(label);
  return marker;
}

// Reverse geocode using Nominatim API
async function reverseGeocode(latlng) {
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng[0]}&lon=${latlng[1]}`);
  const data = await res.json();
  if (data.address.city || data.address.town || data.address.village) {
    $cityName = data.address.city || data.address.town || data.address.village;
    $cityCenter = [parseFloat(data.lat), parseFloat(data.lon)];
  }
}

// Translate dropdown labels based on user language
const translations = {
  'en': {
    pub: 'Pub', shop: 'Shop', hotel: 'Accommodation',
    toilets: 'Toilet', tourist_attraction: 'Tourism',
    bus_station: 'Bus', subway: 'Metro'
  },
  'es': {
    pub: 'Bar', shop: 'Tienda', hotel: 'Alojamiento',
    toilets: 'Ba√±o P√∫blico', tourist_attraction: 'Turismo',
    bus_station: 'Autob√∫s', subway: 'Metro'
  },
  'fr': {
    pub: 'Bar', shop: 'Magasin', hotel: 'H√©bergement',
    toilets: 'Toilettes', tourist_attraction: 'Tourisme',
    bus_station: 'Bus', subway: 'M√©tro'
  },
  'de': {
    pub: 'Bar', shop: 'Gesch√§ft', hotel: 'Unterkunft',
    toilets: 'Toilette', tourist_attraction: 'Sehensw√ºrdigkeit',
    bus_station: 'Bushaltestelle', subway: 'U-Bahn'
  }
};

function detectLanguage() {
  let lang = navigator.language.slice(0,2).toLowerCase();
  return translations[lang] || translations['en'];
}

// Populate dropdown
function populateDropdown() {
  const select = document.getElementById('selectBox');
  const labels = detectLanguage();
  const options = [
    { val: 'pub', text: labels.pub },
    { val: 'shop', text: labels.shop },
    { val: 'hotel', text: labels.hotel },
    { val: 'toilets', text: labels.toilets },
    { val: 'tourist_attraction', text: labels.tourist_attraction },
    { val: 'bus_station', text: labels.bus_station },
    { val: 'subway', text: labels.subway }
  ];
  select.innerHTML = '<option value="">-- Select category --</option>';
  options.forEach(opt => {
    const el = document.createElement('option');
    el.value = opt.val;
    el.textContent = opt.text;
    select.appendChild(el);
  });

  // Attach event listener
  select.addEventListener('change', async () => {
    const $dropdown = select.value;
    if (!$dropdown || !$mygps) return;

    markersLayer.clearLayers();
    addMarker($mygps, 'You are here', 'blue');
    if ($cityCenter) addMarker($cityCenter, `${$cityName} Center`, 'red');

    const $places = await getTopPOIs($dropdown, $mygps);
    $places.forEach(p => {
      const distFromUser = getDistance($mygps, [p.lat, p.lon]).toFixed(1);
      const popupContent = `<strong>${p.name}</strong><br>üìç ${distFromUser} km from you`;
      addMarker([p.lat, p.lon], popupContent);
    });
  });
}

// Get Top 8 POIs near user using Overpass API
async function getTopPOIs(type, latlng) {
  const query = `
  [out:json][timeout:25];
  node["${type === 'hotel' ? 'tourism' : 'amenity'}"="${type}"](around:5000,${latlng[0]},${latlng[1]});
  out body;
  >;
  out skel qt;
  `;

  const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
  const res = await fetch(url);
  const data = await res.json();

  let places = [];
  for (let el of data.elements) {
    if (el.type === "node") {
      places.push({
        name: el.tags.name || "Unnamed",
        lat: el.lat,
        lon: el.lon,
        distance: getDistance(latlng, [el.lat, el.lon])
      });
    }
  }

  // Sort by distance to user
  places.sort((a, b) => a.distance - b.distance);
  return places.slice(0, 8); // Limit to top 8
}

// Distance between two points in km
function getDistance([lat1, lon1], [lat2, lon2]) {
  const R = 6371; // Radius of earth in km
  const dLat = deg2rad(lat2 - lat1);
  const dLon = deg2rad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
function deg2rad(deg) {
  return deg * (Math.PI / 180);
}
</script>
</body>
</html>