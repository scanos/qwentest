<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GPS Location & Nearby Places</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet @1.9.4/dist/leaflet.css" />

    <style>
        #map {
            height: 90vh;
            width: 100%;
        }
        #controls {
            margin: 10px 0;
        }
    </style>
</head>
<body>

<h2>Find Nearby Places</h2>

<div id="controls">
    <label for="poiType">Choose a category:</label>
    <select id="poiType">
        <option value="pub">Pub</option>
        <option value="shop">Shop</option>
        <option value="hotel">Accommodation</option>
        <option value="toilets">Toilet</option>
        <option value="tourist_attraction">Tourism</option>
        <option value="bus_station">Bus</option>
        <option value="subway">Metro</option>
    </select>
    <button onclick="findNearby()">Search</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet @1.9.4/dist/leaflet.js"></script>

<script>
    // Variables
    let mymap;
    let userMarker;
    let $mygps = null;
    let $city = null;
    let $places = [];

    function toRadians(deg) {
        return deg * Math.PI / 180;
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 3958.8; // Earth radius in miles
        const dLat = toRadians(lat2 - lat1);
        const dLon = toRadians(lon2 - lon1);
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function initMap(lat, lon) {
        mymap = L.map('map').setView([lat, lon], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mymap);

        userMarker = L.marker([lat, lon]).addTo(mymap)
            .bindPopup("You are here")
            .openPopup();
    }

    function getCityName(lat, lon) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat= ${lat}&lon=${lon}&zoom=10`)
            .then(response => response.json())
            .then(data => {
                const address = data.address;
                const city = address.city || address.town || address.village || "Unknown";
                $city = { name: city, lat: lat, lon: lon };
                L.marker([$city.lat, $city.lon]).addTo(mymap)
                    .bindPopup(`<b>Nearest City:</b> ${city}<br><b>Distance:</b> ${haversineDistance($mygps.lat, $mygps.lon, $city.lat, $city.lon).toFixed(2)} mi`);
            });
    }

    function translateDropdown(lang) {
        const translations = {
            'es': ['Bar', 'Tienda', 'Alojamiento', 'Baño', 'Turismo', 'Autobús', 'Metro'],
            'fr': ['Bar', 'Boutique', 'Hébergement', 'Toilette', 'Tourisme', 'Bus', 'Métro'],
            'de': ['Bar', 'Geschäft', 'Unterkunft', 'WC', 'Tourismus', 'Bus', 'U-Bahn']
        };

        const langs = Object.keys(translations);
        const closestLang = langs.find(l => lang.startsWith(l)) || 'en';
        const options = translations[closestLang] || [
            'Pub', 'Shop', 'Accommodation', 'Toilet', 'Tourism', 'Bus', 'Metro'
        ];

        const select = document.getElementById("poiType");
        for (let i = 0; i < options.length; i++) {
            select.options[i + 1].text = options[i]; // skip first option
        }
    }

    function findNearby() {
        const dropdown = document.getElementById("poiType");
        const $dropdown = dropdown.value;

        clearMarkers();

        const overpassUrl = `https://overpass-api.de/api/interpreter `;

        const query = `
        [out:json][timeout:25];
        node["amenity"="${$dropdown}"](around:5000,${$mygps.lat},${$mygps.lon});
        out body;
        >;
        out skel qt;`;

        fetch(overpassUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `data=${encodeURIComponent(query)}`
        })
        .then(res => res.json())
        .then(data => {
            const elements = data.elements.slice(0, 8);
            $places = elements.map(el => {
                const dist = haversineDistance($mygps.lat, $mygps.lon, el.lat, el.lon);
                return {
                    name: el.tags.name || "Unnamed",
                    lat: el.lat,
                    lon: el.lon,
                    distance: dist
                };
            });

            plotPlaces();
        });
    }

    function plotPlaces() {
        $places.forEach(place => {
            L.marker([place.lat, place.lon])
                .addTo(mymap)
                .bindPopup(`${place.name}<br>${place.distance.toFixed(2)} mi`);
        });
    }

    function clearMarkers() {
        mymap.eachLayer(layer => {
            if (layer instanceof L.Marker && layer !== userMarker) {
                mymap.removeLayer(layer);
            }
        });
    }

    // Start by getting user's location
    navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        $mygps = { lat, lon };

        initMap(lat, lon);
        getCityName(lat, lon);

        // Detect language and translate dropdown
        const lang = navigator.language || 'en';
        translateDropdown(lang);
    }, error => {
        alert("Unable to retrieve your location.");
    });
</script>

</body>
</html>