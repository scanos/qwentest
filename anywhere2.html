<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Attractions Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Haversine formula for distance calculation
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * 
                Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Reverse geocode to get city information
        async function reverseGeocode(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;
            const response = await fetch(url, {
                headers: { 'Accept-Language': 'en-US' }
            });
            const data = await response.json();
            
            return {
                city: data.address.city || data.address.town || data.address.village || 'Unknown',
                cityLat: parseFloat(data.lat),
                cityLon: parseFloat(data.lon)
            };
        }

        // Get top attractions from OpenStreetMap
        async function getAttractions(lat, lon) {
            const radius = 10000; // 10 km
            const query = `[out:json][timeout:25];node["tourism"="attraction"](around:${radius},${lat},${lon});out;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Process attractions and filter out hotels
                return data.elements
                    .filter(el => el.tags?.name && !el.tags.name.toLowerCase().includes('hotel'))
                    .map(el => ({
                        name: el.tags.name,
                        lat: el.lat,
                        lon: el.lon
                    }))
                    .slice(0, 8);
            } catch (error) {
                console.error('Error fetching attractions:', error);
                return [];
            }
        }

        // Initialize map with user's location
        async function initMap(position) {
            const { latitude: lat, longitude: lon } = position.coords;
            
            // Create map
            const map = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Add user marker
            L.marker([lat, lon]).addTo(map)
                .bindPopup('Your Location')
                .openPopup();

            // Get city information
            try {
                const cityData = await reverseGeocode(lat, lon);
                const { city, cityLat, cityLon } = cityData;
                
                // Add city center marker
                const cityMarker = L.marker([cityLat, cityLon]).addTo(map)
                    .bindPopup(`<strong>${city}</strong>`)
                    .openPopup();

                // Get attractions
                const attractions = await getAttractions(cityLat, cityLon);
                
                // Add attraction markers and calculate distances
                attractions.forEach(attraction => {
                    const distance = getDistance(
                        cityLat, cityLon,
                        attraction.lat, attraction.lon
                    );
                    
                    L.marker([attraction.lat, attraction.lon]).addTo(map)
                        .bindPopup(`${attraction.name}<br>${distance.toFixed(2)} miles from ${city}`);
                });
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to retrieve location data');
            }
        }

        // Handle geolocation errors
        function handleError(error) {
            alert(`Error getting location: ${error.message}`);
        }

        // Start the process
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(initMap, handleError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        } else {
            alert('Geolocation is not supported by this browser');
        }
    </script>
</body>
</html>