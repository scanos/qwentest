<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image Metadata Table</title>
    <script src="exif.js"></script>
</head>
<body>
    <table id="imageTable" border="1">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Latitude</th>
                <th>Longitude</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be added here by JavaScript -->
        </tbody>
    </table>

    <script>
        // Function to convert DMS (Degrees, Minutes, Seconds) to Decimal Degrees
        function dmsToDecimal(degrees, minutes, seconds, direction) {
            let decimal = degrees + minutes / 60 + seconds / 3600;
            if (direction === 'S' || direction === 'W') {
                decimal *= -1;
            }
            return decimal;
        }

        // Function to extract latitude and longitude from EXIF data
        function getLatLong(exifData) {
            const lat = exifData.GPSLatitude;
            const lon = exifData.GPSLongitude;
            const latRef = exifData.GPSLatitudeRef;
            const lonRef = exifData.GPSLongitudeRef;

            if (lat && lon && latRef && lonRef) {
                const latitude = dmsToDecimal(lat[0], lat[1], lat[2], latRef);
                const longitude = dmsToDecimal(lon[0], lon[1], lon[2], lonRef);
                return { latitude, longitude };
            }
            return null;
        }

        // Function to fetch images and extract EXIF data
        async function fetchImages() {
            try {
                const response = await fetch('https://scanos.github.io/qwentest/');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = doc.querySelectorAll('a[href$=".jpg"], a[href$=".jpeg"]');
                const tableBody = document.querySelector('#imageTable tbody');

                links.forEach(link => {
                    const imageUrl = link.href;
                    const imageName = link.textContent;

                    const img = new Image();
                    img.src = imageUrl;
                    img.crossOrigin = 'Anonymous'; // To avoid CORS issues

                    img.onload = function() {
                        EXIF.getData(img, function() {
                            const exifData = EXIF.getAllTags(this);
                            const latLong = getLatLong(exifData);

                            const row = document.createElement('tr');
                            const nameCell = document.createElement('td');
                            nameCell.textContent = imageName;
                            row.appendChild(nameCell);

                            if (latLong) {
                                const latCell = document.createElement('td');
                                latCell.textContent = latLong.latitude.toFixed(6);
                                row.appendChild(latCell);

                                const lonCell = document.createElement('td');
                                lonCell.textContent = latLong.longitude.toFixed(6);
                                row.appendChild(lonCell);
                            } else {
                                const noDataCell = document.createElement('td');
                                noDataCell.setAttribute('colspan', '2');
                                noDataCell.textContent = 'No GPS data';
                                row.appendChild(noDataCell);
                            }

                            tableBody.appendChild(row);
                        });
                    };

                    img.onerror = function() {
                        console.error('Error loading image:', imageUrl);
                    };
                });
            } catch (error) {
                console.error('Error fetching images:', error);
            }
        }

        // Call the function to fetch images and populate the tab
