<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image Geolocation Map</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        .thumbnail {
            max-width: 100px;
            max-height: 100px;
        }
    </style>
</head>
<body>
    <h1>Image Geolocation Data</h1>
    
    <!-- First Table: Image Info -->
    <table id="imageTable">
        <tr>
            <th>Image Name</th>
            <th>Thumbnail</th>
            <th>Geolocation</th>
        </tr>
    </table>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Second Table: Reverse Geocoded Addresses -->
    <h2>Reverse Geocoded Addresses</h2>
    <table id="addressTable">
        <tr>
            <th>Image Name</th>
            <th>Address</th>
        </tr>
    </table>

    <!-- Walking Directions -->
    <h2>Walking Directions</h2>
    <div id="directions"></div>

    <!-- Scripts -->
    <script src="exif.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2RYFaiLK0eKC3AZlcI45YmcJ7wfEBuiw&loading=async&v=weekly" defer></script>
    <script>
        const imageFiles = ['h1.jpg', 'h2.jpg', 'h3.jpg', 'h4.jpg'];
        let coordinates = [];
        
        // Function to convert GPS coordinates to decimal
        function gpsToDecimal(gpsData, ref) {
            if (!gpsData || gpsData.length < 3) return null;
            const degrees = gpsData[0];
            const minutes = gpsData[1];
            const seconds = gpsData[2];
            let decimal = degrees + (minutes / 60) + (seconds / 3600);
            if (ref === 'S' || ref === 'W') decimal = -decimal;
            return decimal;
        }

        // Load image data and populate first table
        async function loadImageData() {
            const table = document.getElementById('imageTable');
            for (const file of imageFiles) {
                const response = await fetch(file);
                const blob = await response.blob();
                const img = new Image();
                img.src = URL.createObjectURL(blob);

                EXIF.getData(img, function() {
                    const lat = gpsToDecimal(EXIF.getTag(this, 'GPSLatitude'), EXIF.getTag(this, 'GPSLatitudeRef'));
                    const lon = gpsToDecimal(EXIF.getTag(this, 'GPSLongitude'), EXIF.getTag(this, 'GPSLongitudeRef'));
                    
                    const row = table.insertRow();
                    row.insertCell(0).textContent = file;
                    const thumbCell = row.insertCell(1);
                    thumbCell.innerHTML = `<img src="${img.src}" class="thumbnail">`;
                    row.insertCell(2).textContent = lat && lon ? `${lat}, ${lon}` : 'No geolocation data';

                    if (lat && lon) {
                        coordinates.push({file: file, lat: lat, lng: lon});
                    }
                });
            }
        }

        // Initialize Map and add markers
        async function initMap() {
            await loadImageData();
            
            const { Map } = await google.maps.importLibrary("maps");
            const { Marker } = await google.maps.importLibrary("marker");
            
            const map = new Map(document.getElementById("map"), {
                center: { lat: 33.8938, lng: 35.5018 }, // Beirut, Lebanon
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            // Add markers
            coordinates.forEach(coord => {
                new Marker({
                    position: { lat: coord.lat, lng: coord.lng },
                    map: map,
                    title: coord.file
                });
            });

            // Reverse Geocoding
            const geocoder = new google.maps.Geocoder();
            const addressTable = document.getElementById('addressTable');
            coordinates.forEach(coord => {
                geocoder.geocode({ location: { lat: coord.lat, lng: coord.lng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const row = addressTable.insertRow();
                        row.insertCell(0).textContent = coord.file;
                        row.insertCell(1).textContent = results[0].formatted_address;
                    }
                });
            });

            // Walking Directions
            if (coordinates.length > 1) {
                const directionsService = new google.maps.DirectionsService();
                const waypoints = coordinates.slice(1, -1).map(coord => ({
                    location: { lat: coord.lat, lng: coord.lng },
                    stopover: true
                }));
                
                directionsService.route({
                    origin: { lat: coordinates[0].lat, lng: coordinates[0].lng },
                    destination: { lat: coordinates[coordinates.length-1].lat, lng: coordinates[coordinates.length-1].lng },
                    waypoints: waypoints,
                    travelMode: google.maps.TravelMode.WALKING,
                    optimizeWaypoints: true
                }, (response, status) => {
                    if (status === 'OK') {
                        const directionsDiv = document.getElementById('directions');
                        response.routes[0].legs.forEach((leg, index) => {
                            directionsDiv.innerHTML += `<p>Leg ${index + 1}: ${leg.start_address} to ${leg.end_address} - ${leg.distance.text} (${leg.duration.text})</p>`;
                        });
                    }
                });
            }
        }

        // Start everything
        window.addEventListener('load', initMap);
    </script>
</body>
</html>
