<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Geolocation Map</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        img {
            max-width: 100px;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Image Geolocation Data</h1>
    
    <!-- Image Data Table -->
    <table id="imageTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Thumbnail</th>
                <th>Geolocation</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Reverse Geocoding Table -->
    <table id="addressTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Coordinates</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Scripts -->
    <script src="exif.js"></script>
    <script>
        // Image array
        const images = ['h1.jpg', 'h2.jpg', 'h3.jpg', 'h4.jpg'];
        let map;
        let geocoder;
        const coordinates = [];

        // Convert EXIF GPS coordinates to decimal
        function gpsToDecimal(gpsData, ref) {
            if (!gpsData || !gpsData.length) return null;
            const degrees = gpsData[0];
            const minutes = gpsData[1];
            const seconds = gpsData[2];
            let decimal = degrees + (minutes / 60) + (seconds / 3600);
            if (ref === 'S' || ref === 'W') decimal *= -1;
            return decimal;
        }

        // Process images and populate table
        async function processImages() {
            const tbody = document.querySelector('#imageTable tbody');
            for (const img of images) {
                const row = document.createElement('tr');
                
                // Image name cell
                const nameCell = document.createElement('td');
                nameCell.textContent = img;
                row.appendChild(nameCell);

                // Thumbnail cell
                const thumbCell = document.createElement('td');
                const thumbImg = document.createElement('img');
                thumbImg.src = img;
                thumbCell.appendChild(thumbImg);
                row.appendChild(thumbCell);

                // Geolocation cell
                const geoCell = document.createElement('td');
                try {
                    const response = await fetch(img);
                    const blob = await response.blob();
                    const exifData = await new Promise((resolve) => {
                        EXIF.getData(blob, function() {
                            resolve(this.exifdata);
                        });
                    });

                    const lat = gpsToDecimal(exifData.GPSLatitude, exifData.GPSLatitudeRef);
                    const lon = gpsToDecimal(exifData.GPSLongitude, exifData.GPSLongitudeRef);
                    
                    if (lat && lon) {
                        geoCell.textContent = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
                        coordinates.push({img, lat, lon});
                    } else {
                        geoCell.textContent = 'No geolocation data';
                    }
                } catch (error) {
                    geoCell.textContent = 'Error reading geolocation';
                    console.error(error);
                }
                row.appendChild(geoCell);
                tbody.appendChild(row);
            }
        }

        // Initialize Google Map
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 33.8938, lng: 35.5018}, // Beirut, Lebanon
                zoom: 15,
                mapTypeId: 'roadmap'
            });

            geocoder = new google.maps.Geocoder();
            
            // Add markers and process reverse geocoding
            coordinates.forEach(coord => {
                const marker = new google.maps.Marker({
                    position: {lat: coord.lat, lng: coord.lon},
                    map: map,
                    title: coord.img
                });
                reverseGeocode(coord);
            });
        }

        // Reverse geocode coordinates
        function reverseGeocode(coord) {
            const tbody = document.querySelector('#addressTable tbody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${coord.img}</td>
                <td>${coord.lat.toFixed(6)}, ${coord.lon.toFixed(6)}</td>
                <td id="addr-${coord.img}">Loading...</td>
            `;
            tbody.appendChild(row);

            geocoder.geocode({location: {lat: coord.lat, lng: coord.lon}}, (results, status) => {
                const addrCell = document.getElementById(`addr-${coord.img}`);
                if (status === 'OK' && results[0]) {
                    addrCell.textContent = results[0].formatted_address;
                } else {
                    addrCell.textContent = 'Address not found';
                }
            });
        }

        // Start processing
        window.onload = () => {
            processImages();
        };
    </script>
    
    <!-- Load Google Maps API asynchronously -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2RYFaiLK0eKC3AZlcI45YmcJ7wfEBuiw&callback=initMap">
    </script>
</body>
</html>
