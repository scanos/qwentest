<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Geolocation and Walking Route</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        .thumbnail {
            max-width: 100px;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Image Geolocation Data</h1>
    <table id="imageTable">
        <tr>
            <th>Image Name</th>
            <th>Thumbnail</th>
            <th>Geolocation</th>
        </tr>
    </table>

    <h1>Reverse Geocoded Locations and Walking Directions</h1>
    <table id="routeTable">
        <tr>
            <th>Image Name</th>
            <th>Address</th>
            <th>Walking Directions</th>
        </tr>
    </table>

    <h1>Map with Markers</h1>
    <div id="map"></div>

    <script src="exif.js"></script>
    <script>
        const imageFiles = ['h1.jpg', 'h2.jpg', 'h3.jpg', 'h4.jpg'];
        let coordinates = [];
        let geocoder, directionsService, map;

        // Function to convert EXIF GPS to decimal degrees
        function toDecimalDegrees(value, ref) {
            const [degrees, minutes, seconds] = value;
            let decimal = degrees + minutes / 60 + seconds / 3600;
            return ref === 'S' || ref === 'W' ? -decimal : decimal;
        }

        // Load image data into the first table
        async function loadImageData() {
            const table = document.getElementById('imageTable');
            for (const file of imageFiles) {
                const img = new Image();
                img.src = file;

                await new Promise((resolve) => {
                    img.onload = () => {
                        EXIF.getData(img, function() {
                            const lat = EXIF.getTag(this, 'GPSLatitude');
                            const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
                            const lon = EXIF.getTag(this, 'GPSLongitude');
                            const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');

                            const row = table.insertRow();
                            row.insertCell(0).textContent = file;
                            row.insertCell(1).innerHTML = `<img src="${file}" class="thumbnail">`;

                            if (lat && lon) {
                                const latitude = toDecimalDegrees(lat, latRef);
                                const longitude = toDecimalDegrees(lon, lonRef);
                                coordinates.push({ lat: latitude, lng: longitude, name: file });
                                row.insertCell(2).textContent = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
                            } else {
                                row.insertCell(2).textContent = 'No geolocation data';
                            }
                            resolve();
                        });
                    };
                });
            }
            processCoordinates();
        }

        // Process coordinates for reverse geocoding and directions
        function processCoordinates() {
            const routeTable = document.getElementById('routeTable');
            coordinates.forEach((coord, index) => {
                const row = routeTable.insertRow();
                row.insertCell(0).textContent = coord.name;

                // Reverse geocode
                geocoder.geocode({ location: { lat: coord.lat, lng: coord.lng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        row.insertCell(1).textContent = results[0].formatted_address;
                    } else {
                        row.insertCell(1).textContent = 'Unable to geocode';
                    }
                });

                // Walking directions (to be filled after all coordinates are processed)
                row.insertCell(2).textContent = 'Calculating...';
            });

            // Calculate walking directions
            calculateWalkingDirections();
        }

        // Calculate walking directions between all points
        function calculateWalkingDirections() {
            if (coordinates.length < 2) return;

            const waypoints = coordinates.slice(1, -1).map(coord => ({
                location: { lat: coord.lat, lng: coord.lng },
                stopover: true
            }));

            directionsService.route({
                origin: { lat: coordinates[0].lat, lng: coordinates[0].lng },
                destination: { lat: coordinates[coordinates.length - 1].lat, lng: coordinates[coordinates.length - 1].lng },
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.WALKING,
                optimizeWaypoints: true
            }, (response, status) => {
                if (status === 'OK') {
                    const routeTable = document.getElementById('routeTable');
                    const legs = response.routes[0].legs;
                    for (let i = 0; i < legs.length; i++) {
                        const steps = legs[i].steps.map(step => step.instructions).join('<br>');
                        routeTable.rows[i + 1].cells[2].innerHTML = steps;
                    }
                } else {
                    console.error('Directions request failed due to ' + status);
                }
            });
        }

        // Initialize the map and add markers
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: { lat: 33.8938, lng: 35.5018 }, // Beirut, Lebanon
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();

            // Add markers
            coordinates.forEach(coord => {
                new google.maps.Marker({
                    position: { lat: coord.lat, lng: coord.lng },
                    map: map,
                    title: coord.name
                });
            });

            // Load image data after map is initialized
            loadImageData();
        }
    </script>

    <!-- Load Google Maps API asynchronously -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
    </script>
</body>
</html>
