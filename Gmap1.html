<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Geolocation Map Grok</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #map {
            height: 400px;
            width: 100%;
            margin: 20px 0;
        }
        img.thumbnail {
            max-width: 100px;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Image Geolocation Data</h1>
    
    <!-- Table for image data -->
    <table id="imageTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Thumbnail</th>
                <th>Geolocation</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Map container -->
    <div id="map"></div>

    <!-- Table for reverse geocoded addresses -->
    <h2>Reverse Geocoded Addresses</h2>
    <table id="addressTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Coordinates</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Walking route directions -->
    <h2>Walking Route from h1.jpg</h2>
    <div id="directions"></div>

    <!-- Scripts -->
    <script src="exif.js"></script>
    <script>
        const images = ['h1.jpg', 'h2.jpg', 'h3.jpg', 'h4.jpg'];
        let coordinates = [];
        
        // Function to convert GPS coordinates to decimal
        function gpsToDecimal(gpsData, ref) {
            let decimal = gpsData[0] + gpsData[1]/60 + gpsData[2]/3600;
            return (ref === 'S' || ref === 'W') ? -decimal : decimal;
        }

        // Process images and populate table
        async function processImages() {
            const tbody = document.querySelector('#imageTable tbody');
            
            for (let image of images) {
                const response = await fetch(image);
                const blob = await response.blob();
                
                EXIF.getData(blob, function() {
                    const lat = EXIF.getTag(this, 'GPSLatitude');
                    const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
                    const lon = EXIF.getTag(this, 'GPSLongitude');
                    const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');
                    
                    let latDecimal = lat ? gpsToDecimal(lat, latRef) : null;
                    let lonDecimal = lon ? gpsToDecimal(lon, lonRef) : null;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${image}</td>
                        <td><img src="${image}" class="thumbnail" alt="${image}"></td>
                        <td>${latDecimal && lonDecimal ? `${latDecimal}, ${lonDecimal}` : 'No GPS data'}</td>
                    `;
                    tbody.appendChild(row);

                    if (latDecimal && lonDecimal) {
                        coordinates.push({
                            image: image,
                            lat: latDecimal,
                            lng: lonDecimal
                        });
                    }
                });
            }
        }

        // Initialize Google Map
        function initMap() {
            const beirut = { lat: 33.8938, lng: 35.5018 };
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: beirut,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            // Add markers
            coordinates.forEach(coord => {
                new google.maps.Marker({
                    position: { lat: coord.lat, lng: coord.lng },
                    map: map,
                    title: coord.image
                });
            });

            // Reverse geocode coordinates
            const geocoder = new google.maps.Geocoder();
            const addressTbody = document.querySelector('#addressTable tbody');
            
            coordinates.forEach(coord => {
                geocoder.geocode({ location: { lat: coord.lat, lng: coord.lng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${coord.image}</td>
                            <td>${coord.lat}, ${coord.lng}</td>
                            <td>${results[0].formatted_address}</td>
                        `;
                        addressTbody.appendChild(row);
                    }
                });
            });

            // Calculate walking route
            if (coordinates.length > 1) {
                const directionsService = new google.maps.DirectionsService();
                const directionsRenderer = new google.maps.DirectionsRenderer();
                directionsRenderer.setMap(map);
                
                const waypoints = coordinates.slice(1).map(coord => ({
                    location: { lat: coord.lat, lng: coord.lng },
                    stopover: true
                }));

                directionsService.route({
                    origin: { lat: coordinates[0].lat, lng: coordinates[0].lng },
                    destination: { lat: coordinates[coordinates.length-1].lat, lng: coordinates[coordinates.length-1].lng },
                    waypoints: waypoints,
                    travelMode: google.maps.TravelMode.WALKING
                }, (response, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                        document.getElementById('directions').innerHTML = 
                            'Walking route calculated successfully. See map for details.';
                    } else {
                        document.getElementById('directions').innerHTML = 
                            'Could not calculate walking route: ' + status;
                    }
                });
            }
        }

        // Start processing
        window.onload = processImages;
    </script>
    
    <!-- Load Google Maps API asynchronously -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2RYFaiLK0eKC3AZlcI45YmcJ7wfEBuiw&callback=initMap">
    </script>
</body>
</html>
