<!DOCTYPE html>
<html>
<head>
    <title>Image Geolocation Map</title>
    <style>
        #map { 
            height: 500px; 
            width: 100%; 
            margin-top: 20px; 
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        img {
            max-width: 100px;
            height: auto;
        }
    </style>
    <script src="exif.js"></script>
</head>
<body>
    <h1>Image Geolocation Data</h1>
    
    <!-- Initial Image Data Table -->
    <table id="imageTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Thumbnail</th>
                <th>Geolocation</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Reverse Geocoded Addresses Table -->
    <table id="addressTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Map Container -->
    <div id="map"></div>

    <script>
        const images = ['h1.jpg', 'h2.jpg', 'h3.jpg', 'h4.jpg'];
        let locations = [];
        
        // Function to convert GPS coordinates from EXIF to decimal
        function gpsToDecimal(gpsData, ref) {
            if (!gpsData || gpsData.length < 3) return null;
            let decimal = gpsData[0] + (gpsData[1] / 60) + (gpsData[2] / 3600);
            return (ref === 'S' || ref === 'W') ? -decimal : decimal;
        }

        // Process images and populate initial table
        function processImages() {
            const tbody = document.querySelector('#imageTable tbody');
            images.forEach(image => {
                const img = new Image();
                img.src = image;
                img.onload = function() {
                    EXIF.getData(img, function() {
                        const lat = gpsToDecimal(
                            EXIF.getTag(this, 'GPSLatitude'),
                            EXIF.getTag(this, 'GPSLatitudeRef')
                        );
                        const lng = gpsToDecimal(
                            EXIF.getTag(this, 'GPSLongitude'),
                            EXIF.getTag(this, 'GPSLongitudeRef')
                        );
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${image}</td>
                            <td><img src="${image}" alt="${image}"></td>
                            <td>${lat ? lat.toFixed(6) + ', ' + lng.toFixed(6) : 'No GPS data'}</td>
                        `;
                        tbody.appendChild(row);

                        if (lat && lng) {
                            locations.push({name: image, lat: lat, lng: lng});
                        }
                    });
                };
            });
        }

        // Map initialization function
        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 33.8938, lng: 35.5018}, // Beirut, Lebanon
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            const geocoder = new google.maps.Geocoder();
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true
            });

            // Add markers and reverse geocode
            const addressTbody = document.querySelector('#addressTable tbody');
            locations.forEach(loc => {
                const marker = new google.maps.Marker({
                    position: {lat: loc.lat, lng: loc.lng},
                    map: map,
                    title: loc.name
                });

                geocoder.geocode({location: {lat: loc.lat, lng: loc.lng}}, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${loc.name}</td>
                            <td>${results[0].formatted_address}</td>
                        `;
                        addressTbody.appendChild(row);
                    }
                });
            });

            // Calculate walking route
            if (locations.length > 1) {
                const start = locations[0]; // h1.jpg
                let unvisited = locations.slice(1);
                let waypoints = [];
                let current = start;

                while (unvisited.length > 0) {
                    // Find nearest unvisited location
                    let nearest = unvisited.reduce((prev, curr) => {
                        const prevDist = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(current.lat, current.lng),
                            new google.maps.LatLng(prev.lat, prev.lng)
                        );
                        const currDist = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(current.lat, current.lng),
                            new google.maps.LatLng(curr.lat, curr.lng)
                        );
                        return currDist < prevDist ? curr : prev;
                    });

                    waypoints.push({
                        location: {lat: nearest.lat, lng: nearest.lng},
                        stopover: true
                    });
                    current = nearest;
                    unvisited = unvisited.filter(loc => loc !== nearest);
                }

                directionsService.route({
                    origin: {lat: start.lat, lng: start.lng},
                    destination: {lat: current.lat, lng: current.lng},
                    waypoints: waypoints,
                    travelMode: google.maps.TravelMode.WALKING
                }, (response, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                    } else {
                        console.error('Directions request failed: ' + status);
                    }
                });
            }
        }

        // Load images when page loads
        window.onload = processImages;

        // Note: Replace 'YOUR_API_KEY' with your actual Google Maps API key
    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2RYFaiLK0eKC3AZlcI45YmcJ7wfEBuiw&libraries=geometry&callback=initMap">
    </script>
</body>
</html>
