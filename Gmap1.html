<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Geolocation Display</title>
    <style>
        table {
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        .thumbnail {
            max-width: 100px;
            max-height: 100px;
        }
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Image Geolocation Data</h1>
    
    <!-- Image Data Table -->
    <table id="imageTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Thumbnail</th>
                <th>Geolocation</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Google Map -->
    <div id="map"></div>

    <!-- Reverse Geocoded Addresses Table -->
    <h2>Reverse Geocoded Addresses</h2>
    <table id="addressTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Coordinates</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Scripts -->
    <script src="exif.js"></script>
    <script>
        const imageFiles = ['h1.jpg', 'h2.jpg', 'h3.jpg', 'h4.jpg'];
        let imageData = [];
        let map;
        let geocoder;

        // Convert GPS coordinates from EXIF to decimal
        function gpsToDecimal(gpsData, ref) {
            if (!gpsData || !gpsData.length) return null;
            const degrees = gpsData[0];
            const minutes = gpsData[1];
            const seconds = gpsData[2];
            let decimal = degrees + (minutes / 60) + (seconds / 3600);
            if (ref === 'S' || ref === 'W') decimal = -decimal;
            return decimal;
        }

        // Process images and extract EXIF data
        function processImages() {
            const tbody = document.querySelector('#imageTable tbody');
            
            imageFiles.forEach(file => {
                const img = new Image();
                img.src = file;
                
                img.onload = function() {
                    EXIF.getData(img, function() {
                        const lat = gpsToDecimal(
                            EXIF.getTag(this, 'GPSLatitude'),
                            EXIF.getTag(this, 'GPSLatitudeRef')
                        );
                        const lon = gpsToDecimal(
                            EXIF.getTag(this, 'GPSLongitude'),
                            EXIF.getTag(this, 'GPSLongitudeRef')
                        );
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${file}</td>
                            <td><img src="${file}" class="thumbnail"></td>
                            <td>${lat ? lat.toFixed(6) + ', ' + lon.toFixed(6) : 'N/A'}</td>
                        `;
                        tbody.appendChild(row);

                        if (lat && lon) {
                            imageData.push({ file, lat, lon });
                        }

                        // When all images are processed, initialize map and reverse geocode
                        if (imageData.length === imageFiles.length || 
                            tbody.children.length === imageFiles.length) {
                            initMap();
                        }
                    });
                };
            });
        }

        // Initialize Google Map
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 33.8938, lng: 35.5018 }, // Beirut, Lebanon
                zoom: 15,
                mapTypeId: 'roadmap'
            });

            geocoder = new google.maps.Geocoder();

            // Add markers
            imageData.forEach(data => {
                new google.maps.Marker({
                    position: { lat: data.lat, lng: data.lon },
                    map: map,
                    title: data.file
                });
            });

            // Reverse geocode coordinates
            reverseGeocode();
        }

        // Reverse geocode coordinates
        function reverseGeocode() {
            const tbody = document.querySelector('#addressTable tbody');
            
            imageData.forEach(data => {
                const latlng = { lat: data.lat, lng: data.lon };
                
                geocoder.geocode({ location: latlng }, (results, status) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.file}</td>
                        <td>${data.lat.toFixed(6)}, ${data.lon.toFixed(6)}</td>
                        <td>${status === 'OK' ? results[0].formatted_address : 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        // Start processing when page loads
        window.onload = processImages;
    </script>

    <!-- Google Maps API with async loading -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
    </script>
</body>
</html>
