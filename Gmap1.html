<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Geolocation Map</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        .thumbnail {
            max-width: 100px;
            max-height: 100px;
        }
    </style>
</head>
<body>
    <h1>Image Geolocation Data</h1>
    
    <!-- First Table: Image Info -->
    <table id="imageTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Thumbnail</th>
                <th>Geolocation</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Second Table: Reverse Geocoded Addresses -->
    <table id="addressTable">
        <thead>
            <tr>
                <th>Image Name</th>
                <th>Coordinates</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Walking Directions -->
    <h2>Walking Directions</h2>
    <div id="directions"></div>

    <!-- Scripts -->
    <script src="exif.js"></script>
    <script>
        const imageFiles = ['h1.jpg', 'h2.jpg', 'h3.jpg', 'h4.jpg'];
        let imageLocations = [];
        
        // Process images and populate first table
        function processImages() {
            const tbody = document.querySelector('#imageTable tbody');
            
            imageFiles.forEach(file => {
                const img = new Image();
                img.src = file;
                
                img.onload = function() {
                    EXIF.getData(img, function() {
                        const lat = EXIF.getTag(this, 'GPSLatitude');
                        const lon = EXIF.getTag(this, 'GPSLongitude');
                        const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
                        const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');

                        let latLon = 'No geolocation data';
                        let coordinates = null;

                        if (lat && lon) {
                            const latitude = convertDMSToDD(lat, latRef);
                            const longitude = convertDMSToDD(lon, lonRef);
                            latLon = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                            coordinates = {lat: latitude, lng: longitude};
                            imageLocations.push({file: file, coords: coordinates});
                        }

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${file}</td>
                            <td><img src="${file}" class="thumbnail" alt="${file}"></td>
                            <td>${latLon}</td>
                        `;
                        tbody.appendChild(row);
                    });
                };
            });
        }

        // Convert DMS to Decimal Degrees
        function convertDMSToDD(dms, ref) {
            if (!dms) return 0;
            const degrees = dms[0];
            const minutes = dms[1];
            const seconds = dms[2];
            let dd = degrees + minutes/60 + seconds/3600;
            if (ref === 'S' || ref === 'W') dd = -dd;
            return dd;
        }

        // Google Maps initialization
        function initMap() {
            const beirut = {lat: 33.8938, lng: 35.5018}; // Beirut coordinates
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: beirut,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            const geocoder = new google.maps.Geocoder();
            const directionsService = new google.maps.DirectionsService();
            const addressTbody = document.querySelector('#addressTable tbody');

            // Add markers and reverse geocode
            imageLocations.forEach(location => {
                if (location.coords) {
                    const marker = new google.maps.Marker({
                        position: location.coords,
                        map: map,
                        title: location.file
                    });

                    // Reverse geocode
                    geocoder.geocode({location: location.coords}, (results, status) => {
                        let address = 'Unable to geocode';
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            address = results[0].formatted_address;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${location.file}</td>
                            <td>${location.coords.lat.toFixed(6)}, ${location.coords.lng.toFixed(6)}</td>
                            <td>${address}</td>
                        `;
                        addressTbody.appendChild(row);
                    });
                }
            });

            // Calculate walking directions
            if (imageLocations.length > 1) {
                const waypoints = imageLocations.slice(1, -1).map(loc => ({
                    location: loc.coords,
                    stopover: true
                }));

                directionsService.route({
                    origin: imageLocations[0].coords,
                    destination: imageLocations[imageLocations.length - 1].coords,
                    waypoints: waypoints,
                    travelMode: google.maps.TravelMode.WALKING
                }, (response, status) => {
                    if (status === google.maps.DirectionsStatus.OK) {
                        const directionsRenderer = new google.maps.DirectionsRenderer();
                        directionsRenderer.setMap(map);
                        directionsRenderer.setPanel(document.getElementById('directions'));
                        directionsRenderer.setDirections(response);
                    } else {
                        document.getElementById('directions').innerHTML = 'Unable to calculate walking directions';
                    }
                });
            }
        }

        // Start processing
        window.onload = processImages;
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2RYFaiLK0eKC3AZlcI45YmcJ7wfEBuiw&callback=initMap">
    </script>
</body>
</html>
