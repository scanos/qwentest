<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Top 10 Places to Visit in Braga</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
    .info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info" id="info">Click on a marker to get walking directions.</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize the map
    const map = L.map('map').setView([41.5503, -8.4201], 14); // Centered on Braga

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Top 10 places to visit in Braga
    const places = [
      { name: "Bom Jesus do Monte", lat: 41.5507, lng: -8.3965 },
      { name: "Braga Cathedral", lat: 41.5499, lng: -8.4267 },
      { name: "Theatro Circo", lat: 41.5512, lng: -8.4238 },
      { name: "Santa Bárbara Garden", lat: 41.5523, lng: -8.4212 },
      { name: "Arco da Porta Nova", lat: 41.5504, lng: -8.4263 },
      { name: "Sanctuary of Sameiro", lat: 41.5611, lng: -8.4006 },
      { name: "Palace of the Dukes of Braganza", lat: 41.5507, lng: -8.4268 },
      { name: "Rua do Souto", lat: 41.5506, lng: -8.4256 },
      { name: "Museu dos Biscainhos", lat: 41.5496, lng: -8.4269 },
      { name: "Câmara Municipal de Braga", lat: 41.5508, lng: -8.4258 }
    ];

    // Add markers for each place
    places.forEach(place => {
      const marker = L.marker([place.lat, place.lng]).addTo(map);
      marker.bindPopup(place.name);

      // Add click event to marker
      marker.on('click', async () => {
        try {
          // Get user's current location or fallback to default
          const userLocation = await getUserLocationOrFallback();
          const destination = [place.lat, place.lng];

          // Calculate walking directions
          const route = await getWalkingDirections(userLocation, destination);

          // Display route on the map
          displayRoute(route);

          // Speak the distance
          const distanceInKm = route.distance / 1000; // Convert meters to kilometers
          speakDistance(distanceInKm.toFixed(2));

          // Update info box
          document.getElementById('info').innerText = `Walking to ${place.name}. Distance: ${distanceInKm.toFixed(2)} km.`;
        } catch (error) {
          alert("Error: " + error.message);
        }
      });
    });

    // Function to get user's current location or fallback to default
    function getUserLocationOrFallback() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error("Geolocation is not supported by your browser."));
        }

        navigator.geolocation.getCurrentPosition(
          position => resolve([position.coords.latitude, position.coords.longitude]),
          error => {
            if (error.code === error.PERMISSION_DENIED) {
              alert("You denied the geolocation request. Using a default location in Braga.");
              resolve([41.5503, -8.4201]); // Default location: Braga city center
            } else {
              reject(error);
            }
          }
        );
      });
    }

    // Function to get walking directions using OpenRouteService API
    async function getWalkingDirections(start, end) {
      const apiKey = "5b3ce3597851110001cf62487ddb3015f9954697b251afa2361c2b30"; // Replace with your OpenRouteService API key
      const url = `https://api.openrouteservice.org/v2/directions/foot-walking?api_key=${apiKey}&start=${start[1]},${start[0]}&end=${end[1]},${end[0]}`;
      
      const response = await fetch(url);
      if (!response.ok) throw new Error("Failed to fetch directions.");

      const data = await response.json();

      // Debugging: Log the API response
      console.log("API Response:", data);

      // Validate the response structure
      if (!data.features || !data.features[0] || !data.features[0].geometry) {
        throw new Error("Invalid route data received from the API.");
      }

      return data.features[0].properties.summary;
    }

    // Function to display the route on the map
    function displayRoute(route) {
      if (map.routeLayer) map.removeLayer(map.routeLayer);

      // Validate the geometry
      if (!route.geometry || !route.geometry.coordinates) {
        throw new Error("Route geometry is undefined.");
      }

      const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
      map.routeLayer = L.polyline(coordinates, { color: 'blue' }).addTo(map);
      map.fitBounds(map.routeLayer.getBounds());
    }

    // Function to speak the distance
    function speakDistance(distance) {
      const utterance = new SpeechSynthesisUtterance(`The destination is ${distance} kilometers away.`);
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>