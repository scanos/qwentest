<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearest Places</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; max-width: 800px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        #status { margin-bottom: 20px; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>Nearest Places to Your Location</h2>
    <div id="status">Waiting for location...</div>
    <table id="placesTable">
        <thead>
            <tr>
                <th>Place Description</th>
                <th>Distance (miles)</th>
            </tr>
        </thead>
        <tbody id="placesBody"></tbody>
    </table>

    <script>
        // Variable to store GPS coordinates
        let $mygps = null;

        // Function to calculate distance using Haversine formula (in miles)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Earth's radius in miles
            const toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Function to fetch nearby places using Nominatim
        async function fetchNearbyPlaces(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=8&q=point_of_interest&lat=${lat}&lon=${lon}&zoom=15&addressdetails=1`;
            try {
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'Grok3-NearestPlaces/1.0 (Contact: support@x.ai)'
                    }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const places = await response.json();
                return places.map(place => ({
                    description: place.display_name,
                    lat: parseFloat(place.lat),
                    lon: parseFloat(place.lon),
                    distance: haversineDistance(lat, lon, place.lat, place.lon)
                })).sort((a, b) => a.distance - b.distance);
            } catch (error) {
                console.error('Error fetching places:', error);
                document.getElementById('status').className = 'error';
                document.getElementById('status').textContent = 'Error fetching nearby places.';
                return [];
            }
        }

        // Function to update table with places
        function updateTable(places) {
            const tbody = document.getElementById('placesBody');
            tbody.innerHTML = '';
            if (places.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2">No places found.</td></tr>';
                return;
            }
            places.forEach(place => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${place.description}</td>
                    <td>${place.distance.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Get current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    $mygps = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    document.getElementById('status').textContent = 
                        `Location found: (${$mygps.latitude.toFixed(4)}, ${$mygps.longitude.toFixed(4)})`;
                    
                    // Fetch and display nearby places
                    const places = await fetchNearbyPlaces($mygps.latitude, $mygps.longitude);
                    updateTable(places);
                },
                (error) => {
                    document.getElementById('status').className = 'error';
                    document.getElementById('status').textContent = 
                        `Error getting location: ${error.message}`;
                }
            );
        } else {
            document.getElementById('status').className = 'error';
            document.getElementById('status').textContent = 
                'Geolocation is not supported by this browser.';
        }
    </script>
</body>
</html>