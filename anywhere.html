<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Places to See</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 400px; }
        @media (min-width: 640px) { #map { height: 500px; } }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 id="page-title" class="text-2xl md:text-3xl font-bold text-center mb-4">Places to See</h1>
        <div id="map" class="w-full mb-4 rounded-lg shadow"></div>
        <div id="status" class="text-center text-gray-600 mb-4">Loading location...</div>
        <div class="overflow-x-auto">
            <table id="attractions-table" class="w-full bg-white shadow-md rounded-lg">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="py-2 px-4 text-left">Attraction</th>
                        <th class="py-2 px-4 text-left">GPS Coordinates</th>
                        <th class="py-2 px-4 text-left">Distance (km)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // Initialize variables
        let mygps = null;
        let cityname = "Unknown";
        let city = null;

        // Get user's GPS coordinates
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        mygps = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        document.getElementById('status').textContent = `Location found: ${mygps.lat}, ${mygps.lon}`;
                        getNearestCity();
                    },
                    (error) => {
                        document.getElementById('status').textContent = `Error: Unable to retrieve location (${error.message})`;
                    }
                );
            } else {
                document.getElementById('status').textContent = "Geolocation is not supported by this browser.";
            }
        }

        // Get nearest city using Nominatim
        async function getNearestCity() {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${mygps.lat}&lon=${mygps.lon}&zoom=10&addressdetails=1`
                );
                const data = await response.json();
                cityname = data.address.city || data.address.town || data.address.village || "Unknown";
                city = { lat: parseFloat(data.lat), lon: parseFloat(data.lon) };

                // If cityname is "Unknown", refine using a broader search
                if (cityname === "Unknown") {
                    const searchResponse = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=nearby+city&lat=${mygps.lat}&lon=${mygps.lon}&limit=1`
                    );
                    const searchData = await searchResponse.json();
                    if (searchData.length > 0) {
                        cityname = searchData[0].display_name.split(',')[0];
                        city = { lat: parseFloat(searchData[0].lat), lon: parseFloat(searchData[0].lon) };
                    }
                }

                // Update page title
                document.getElementById('page-title').textContent = `Places to See in ${cityname}`;
                initMap();
                getTourismAttractions();
            } catch (error) {
                document.getElementById('status').textContent = `Error fetching city: ${error.message}`;
            }
        }

        // Initialize OpenStreetMap with Leaflet
        function initMap() {
            const map = L.map('map').setView([mygps.lat, mygps.lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.marker([mygps.lat, mygps.lon]).addTo(map)
                .bindPopup('Your Location').openPopup();
        }

        // Haversine formula to calculate distance between two GPS points (in km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Query Overpass API for tourism attractions with fallback tags
        async function getTourismAttractions() {
            const tags = ['attraction', 'museum', 'theme_park', 'artwork'];
            let attractionsFound = false;
            let usedTag = '';

            for (const tag of tags) {
                try {
                    const query = `
                        [out:json];
                        node(around:5000,${mygps.lat},${mygps.lon})["tourism"="${tag}"];
                        out body 8;
                    `;
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        body: query
                    });
                    const data = await response.json();

                    if (data.elements.length > 0) {
                        attractionsFound = true;
                        usedTag = tag;
                        const tableBody = document.querySelector('#attractions-table tbody');
                        tableBody.innerHTML = ''; // Clear table

                        data.elements.forEach((element) => {
                            const name = element.tags.name || `Unnamed ${tag}`;
                            const description = element.tags.description || 'No description available';
                            const lat = element.lat;
                            const lon = element.lon;
                            const distance = calculateDistance(mygps.lat, mygps.lon, lat, lon).toFixed(2);

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="py-2 px-4">${name}: ${description}</td>
                                <td class="py-2 px-4">${lat.toFixed(6)}, ${lon.toFixed(6)}</td>
                                <td class="py-2 px-4">${distance}</td>
                            `;
                            tableBody.appendChild(row);
                        });

                        document.getElementById('status').textContent = `Found ${data.elements.length} ${tag}(s) within 5km.`;
                        break; // Exit loop once attractions are found
                    }
                } catch (error) {
                    document.getElementById('status').textContent = `Error fetching ${tag}s: ${error.message}`;
                    return;
                }
            }

            if (!attractionsFound) {
                document.getElementById('status').textContent = 'No tourism attractions, museums, theme parks, or artworks found within 5km.';
            }
        }

        // Start the process
        getUserLocation();
    </script>
</body>
</html>