<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSM Key-Value Pairs Near Me</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
    <h1 class="text-2xl font-bold text-center mb-4">Nearby OSM Key-Value Pairs</h1>
    <div id="status" class="text-center mb-4">
      <p class="text-gray-600">Fetching your location...</p>
    </div>
    <div id="coordinates" class="text-center mb-4 hidden">
      <p class="text-lg font-semibold">Your GPS Coordinates:</p>
      <p id="gps-text" class="text-gray-800"></p>
    </div>
    <div id="tags" class="max-h-96 overflow-y-auto hidden">
      <h2 class="text-lg font-semibold mb-2">Nearest 100 Unique Key-Value Pairs:</h2>
      <ul id="tags-list" class="list-disc pl-5 space-y-1 text-gray-700"></ul>
    </div>
  </div>

  <script>
    // Initialize $mygps
    let $mygps = { latitude: null, longitude: null };

    // Function to calculate approximate distance (for sorting, if needed)
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth's radius in meters
      const φ1 = (lat1 * Math.PI) / 180;
      const φ2 = (lat2 * Math.PI) / 180;
      const Δφ = ((lat2 - lat1) * Math.PI) / 180;
      const Δλ = ((lon2 - lon1) * Math.PI) / 180;
      const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distance in meters
    }

    // Function to fetch OSM data via Overpass API
    async function fetchOSMTags(lat, lon) {
      const radius = 100; // 100 meters
      const overpassQuery = `
        [out:json];
        (
          node(around:${radius},${lat},${lon});
          way(around:${radius},${lat},${lon});
          relation(around:${radius},${lat},${lon});
        );
        out tags;
      `;
      const url = 'https://overpass-api.de/api/interpreter';
      try {
        const response = await fetch(url, {
          method: 'POST',
          body: overpassQuery
        });
        if (!response.ok) throw new Error('Failed to fetch OSM data');
        const data = await response.json();
        return data.elements;
      } catch (error) {
        throw error;
      }
    }

    // Process tags to get unique key-value pairs
    function processTags(elements, userLat, userLon) {
      const tagSet = new Set();
      const tagsWithDistance = [];

      elements.forEach(element => {
        if (element.tags) {
          const lat = element.lat || (element.center ? element.center.lat : null);
          const lon = element.lon || (element.center ? element.center.lon : null);
          let distance = Infinity;
          if (lat && lon) {
            distance = getDistance(userLat, userLon, lat, lon);
          }
          for (const [key, value] of Object.entries(element.tags)) {
            const tagString = `${key}=${value}`;
            if (!tagSet.has(tagString)) {
              tagSet.add(tagString);
              tagsWithDistance.push({ tag: tagString, distance });
            }
          }
        }
      });

      // Sort by distance and take top 100
      return tagsWithDistance
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 100)
        .map(item => item.tag);
    }

    // Display tags in the UI
    function displayTags(tags) {
      const tagsList = document.getElementById('tags-list');
      tagsList.innerHTML = '';
      tags.forEach(tag => {
        const li = document.createElement('li');
        li.textContent = tag;
        tagsList.appendChild(li);
      });
      document.getElementById('tags').classList.remove('hidden');
    }

    // Handle geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          $mygps.latitude = position.coords.latitude;
          $mygps.longitude = position.coords.longitude;

          // Update UI with coordinates
          document.getElementById('status').classList.add('hidden');
          document.getElementById('coordinates').classList.remove('hidden');
          document.getElementById('gps-text').textContent = 
            `Latitude: ${$mygps.latitude.toFixed(6)}, Longitude: ${$mygps.longitude.toFixed(6)}`;

          try {
            // Fetch and process OSM tags
            const elements = await fetchOSMTags($mygps.latitude, $mygps.longitude);
            const uniqueTags = processTags(elements, $mygps.latitude, $mygps.longitude);
            displayTags(uniqueTags);
          } catch (error) {
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('status').innerHTML = 
              `<p class="text-red-600">Error fetching OSM data: ${error.message}</p>`;
          }
        },
        (error) => {
          document.getElementById('status').classList.remove('hidden');
          document.getElementById('status').innerHTML = 
            `<p class="text-red-600">Error getting location: ${error.message}</p>`;
        }
      );
    } else {
      document.getElementById('status').classList.remove('hidden');
      document.getElementById('status').innerHTML = 
        `<p class="text-red-600">Geolocation is not supported by this browser.</p>`;
    }
  </script>
</body>
</html>