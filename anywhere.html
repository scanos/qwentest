<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearest OSM Key-Value Pairs</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #map {
            flex: 1;
            min-height: 50%;
        }
        #info {
            padding: 10px;
            background: #f0f0f0;
            overflow-y: auto;
            max-height: 50%;
        }
        h2 {
            margin: 0 0 10px;
            font-size: 1.2em;
        }
        ul {
            margin: 0;
            padding: 0 0 0 20px;
        }
        li {
            margin-bottom: 10px;
        }
        .error {
            color: red;
        }
        @media (min-width: 768px) {
            body {
                flex-direction: row;
            }
            #map {
                min-height: 100%;
                width: 70%;
            }
            #info {
                width: 30%;
                max-height: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info">
        <h2>Nearest OSM Key-Value Pairs</h2>
        <div id="content">Fetching location...</div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Variable to store GPS coordinates
        let mygps = { lat: null, lng: null };

        // Initialize map
        const map = L.map('map').setView([0, 0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Function to update info panel
        function updateInfo(content) {
            document.getElementById('content').innerHTML = content;
        }

        // Get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    mygps.lat = position.coords.latitude;
                    mygps.lng = position.coords.longitude;
                    map.setView([mygps.lat, mygps.lng], 15);
                    L.marker([mygps.lat, mygps.lng])
                        .addTo(map)
                        .bindPopup('Your Location')
                        .openPopup();
                    fetchOSMData();
                },
                (error) => {
                    updateInfo(`<p class="error">Error: ${error.message}. Please enable location services.</p>`);
                }
            );
        } else {
            updateInfo('<p class="error">Geolocation is not supported by this browser.</p>');
        }

        // Fetch OSM data using Overpass API
        function fetchOSMData() {
            const query = `
                [out:json][timeout:25];
                node(around:100,${mygps.lat},${mygps.lng});
                out body 8;
            `;
            const url = 'https://overpass-api.de/api/interpreter';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'data=' + encodeURIComponent(query)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        const nodes = data.elements || [];
                        if (nodes.length === 0) {
                            updateInfo('<p>No OSM nodes found nearby.</p>');
                            return;
                        }
                        let html = '<ul>';
                        nodes.forEach((node, index) => {
                            const tags = node.tags || {};
                            const tagList = Object.entries(tags)
                                .map(([key, value]) => `${key}=${value}`)
                                .join(', ');
                            html += `<li><strong>Node ${index + 1}:</strong> ${tagList || 'No tags'}</li>`;
                            L.marker([node.lat, node.lon])
                                .addTo(map)
                                .bindPopup(tagList || 'No tags');
                        });
                        html += '</ul>';
                        updateInfo(html);
                    } catch (e) {
                        updateInfo(`<p class="error">Error parsing OSM data: ${e.message}. Response: ${text.slice(0, 100)}</p>`);
                    }
                })
                .catch(error => {
                    updateInfo(`<p class="error">Error fetching OSM data: ${error.message}</p>`);
                });
        }
    </script>
</body>
</html>