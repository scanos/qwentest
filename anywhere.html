<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Places to See</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; width: 100%; }
        #loading { display: none; }
        @media (max-width: 640px) {
            #map { height: 400px; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center p-4">
    <h1 id="map-title" class="text-2xl font-bold mb-4">Places to See</h1>
    <div class="w-full max-w-md mb-4">
        <select id="place-type" class="w-full p-2 border rounded">
            <option value="tourism=attraction">Tourist Attraction</option>
            <option value="amenity=cafe">Cafe</option>
            <option value="highway=bus_stop">Bus Stop</option>
            <option value="amenity=bus_station">Bus Station</option>
            <option value="railway=station">Railway Station</option>
            <option value="historic=castle">Historic Castle</option>
            <option value="amenity=place_of_worship">Place of Worship</option>
        </select>
    </div>
    <div id="loading" class="text-lg font-semibold mb-4">Please Wait</div>
    <div id="map" class="w-full max-w-4xl rounded shadow"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Axios for API requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Initialize variables
        let $mygps = null;
        let $cityname = "Unknown";
        let $city = null;
        let $dropdown = "tourism=attraction";
        let $places = [];
        let map, userMarker;

        // Initialize map
        map = L.map('map').setView([51.505, -0.09], 13); // Default view (London)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Haversine formula to calculate distance in miles
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Delay function to respect Nominatim's 1 request/second limit
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Get user's GPS coordinates
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            $mygps = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            resolve($mygps);
                        },
                        error => {
                            alert("Unable to retrieve location. Please enable location services.");
                            reject(error);
                        }
                    );
                } else {
                    alert("Geolocation is not supported by this browser.");
                    reject(new Error("Geolocation not supported"));
                }
            });
        }

        // Reverse geocode to find nearest city using Nominatim
        async function getCityName(coords) {
            try {
                const response = await axios.get('https://nominatim.openstreetmap.org/reverse', {
                    params: {
                        format: 'json',
                        lat: coords.lat,
                        lon: coords.lon,
                        addressdetails: 1
                    }
                });
                const address = response.data.address;
                $cityname = address.city || address.town || address.village || "Unknown";
                $city = {
                    lat: parseFloat(response.data.lat),
                    lon: parseFloat(response.data.lon)
                };
                if ($cityname === "Unknown") {
                    // Fallback to GeoNames
                    const geoResponse = await axios.get('http://api.geonames.org/findNearbyPlaceNameJSON', {
                        params: {
                            lat: coords.lat,
                            lng: coords.lon,
                            username: 'demo' // Replace with your GeoNames username
                        }
                    });
                    if (geoResponse.data.geonames && geoResponse.data.geonames.length > 0) {
                        $cityname = geoResponse.data.geonames[0].name;
                        $city = {
                            lat: parseFloat(geoResponse.data.geonames[0].lat),
                            lon: parseFloat(geoResponse.data.geonames[0].lng)
                        };
                    }
                }
                document.getElementById('map-title').textContent = `Places to See in ${$cityname}`;
            } catch (error) {
                console.error("Error fetching city name:", error);
            }
        }

        // Get nearest places based on dropdown selection
        async function getNearestPlaces() {
            document.getElementById('loading').style.display = 'block';
            $places = [];
            try {
                // Construct Nominatim query
                const [key, value] = $dropdown.split('=');
                const response = await axios.get('https://nominatim.openstreetmap.org/search', {
                    params: {
                        q: `${key}=${value}`,
                        format: 'json',
                        limit: 8,
                        bounded: 1,
                        viewbox: `${$mygps.lon - 0.1},${$mygps.lat - 0.1},${$mygps.lon + 0.1},${$mygps.lat + 0.1}`,
                        addressdetails: 1
                    }
                });
                for (let place of response.data) {
                    let description = place.display_name.split(',')[0].trim();
                    if (description.toLowerCase() === 'unnamed' || description === '') {
                        // Fallback to GeoNames
                        const geoResponse = await axios.get('http://api.geonames.org/findNearbyPlaceNameJSON', {
                            params: {
                                lat: place.lat,
                                lng: place.lon,
                                username: 'demo' // Replace with your GeoNames username
                            }
                        });
                        description = geoResponse.data.geonames && geoResponse.data.geonames.length > 0
                            ? geoResponse.data.geonames[0].name
                            : 'Unknown Place';
                        await delay(1000); // Respect GeoNames rate limit
                    }
                    const coords = {
                        lat: parseFloat(place.lat),
                        lon: parseFloat(place.lon)
                    };
                    const distance = calculateDistance($mygps.lat, $mygps.lon, coords.lat, coords.lon).toFixed(2);
                    $places.push({
                        description: description,
                        coords: coords,
                        distance: distance
                    });
                }
            } catch (error) {
                console.error("Error fetching places:", error);
            }
            document.getElementById('loading').style.display = 'none';
            updateMap();
        }

        // Update map with markers
        function updateMap() {
            // Clear existing markers except user marker
            map.eachLayer(layer => {
                if (layer !== userMarker && layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Add user marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            const distanceToCity = calculateDistance($mygps.lat, $mygps.lon, $city.lat, $city.lon).toFixed(2);
            userMarker = L.marker([$mygps.lat, $mygps.lon])
                .addTo(map)
                .bindPopup(`Your Location<br>${distanceToCity} miles from ${$cityname}`)
                .openPopup();
            map.setView([$mygps.lat, $mygps.lon], 13);

            // Add place markers
            $places.forEach(place => {
                L.marker([place.coords.lat, place.coords.lon])
                    .addTo(map)
                    .bindPopup(`${place.description}<br>${place.distance} miles from you`);
            });
        }

        // Handle dropdown change
        document.getElementById('place-type').addEventListener('change', async (e) => {
            $dropdown = e.target.value;
            await getNearestPlaces();
        });

        // Initialize
        async function init() {
            try {
                await getUserLocation();
                await getCityName($mygps);
                await getNearestPlaces();
            } catch (error) {
                console.error("Initialization error:", error);
            }
        }

        init();
    </script>
</body>
</html>