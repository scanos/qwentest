<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nearby Places</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; max-width: 800px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    #status { margin-bottom: 20px; }
    #error { color: red; }
  </style>
</head>
<body>
  <h1>Nearby Places within 10 Miles</h1>
  <div id="status">Fetching your location...</div>
  <div id="error"></div>
  <table id="placesTable" style="display: none;">
    <thead>
      <tr>
        <th>Tag</th>
        <th>Description</th>
        <th>Distance (miles)</th>
      </tr>
    </thead>
    <tbody id="placesBody"></tbody>
  </table>

  <script>
    // Variable to store GPS coordinates
    let mygps = null;

    // Function to calculate distance using Haversine formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3958.8; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Function to update status message
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    // Function to show error message
    function showError(message) {
      document.getElementById('error').textContent = message;
    }

    // Function to render table with places
    function renderTable(places) {
      const tbody = document.getElementById('placesBody');
      tbody.innerHTML = ''; // Clear existing rows
      places.forEach(place => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${place.tag || 'N/A'}</td>
          <td>${place.display_name}</td>
          <td>${place.distance.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });
      document.getElementById('placesTable').style.display = 'table';
    }

    // Step 1: Get GPS coordinates
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        position => {
          mygps = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };
          updateStatus(`Location acquired: (${mygps.latitude}, ${mygps.longitude}). Fetching nearby places...`);

          // Step 2: Query Nominatim API
          const lat = mygps.latitude;
          const lon = mygps.longitude;
          // Bounding box for 10-mile radius (approx 0.15 degrees at mid-latitudes)
          const delta = 0.15;
          const url = `https://nominatim.openstreetmap.org/search?format=json&limit=8&bounded=1` +
                     `&viewbox=${lon - delta},${lat + delta},${lon + delta},${lat - delta}` +
                     `&q=[place]&accept-language=en`;

          fetch(url, {
            headers: {
              'User-Agent': 'NearbyPlacesApp/1.0 (contact: user@example.com)'
            }
          })
            .then(response => {
              if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              return response.json();
            })
            .then(data => {
              if (data.length === 0) {
                showError('No places found within 10 miles.');
                updateStatus('');
                return;
              }

              // Step 3: Process and sort places by distance
              const places = data.map(item => ({
                tag: item.type || 'N/A',
                display_name: item.display_name,
                latitude: parseFloat(item.lat),
                longitude: parseFloat(item.lon),
                distance: calculateDistance(lat, lon, parseFloat(item.lat), parseFloat(item.lon))
              }))
              .filter(place => place.distance <= 10) // Ensure within 10 miles
              .sort((a, b) => a.distance - b.distance) // Sort by distance
              .slice(0, 8); // Limit to 8 results

              if (places.length === 0) {
                showError('No valid places found within 10 miles.');
                updateStatus('');
                return;
              }

              // Step 4: Render the table
              renderTable(places);
              updateStatus('Places loaded successfully.');
            })
            .catch(error => {
              showError(`Error fetching places: ${error.message}`);
              updateStatus('');
            });
        },
        error => {
          showError('Failed to get location. Please allow location access and try again.');
          updateStatus('');
        }
      );
    } else {
      showError('Geolocation is not supported by your browser.');
      updateStatus('');
    }
  </script>
</body>
</html>