<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearest Places Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-4">Nearest Places to Your Location</h1>
        <div id="status" class="mb-4 text-gray-700">Loading...</div>
        <div id="location-info" class="mb-4"></div>
        <table id="places-table" class="w-full border-collapse hidden">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border p-2">Latitude</th>
                    <th class="border p-2">Longitude</th>
                    <th class="border p-2">Description</th>
                    <th class="border p-2">Distance (miles)</th>
                </tr>
            </thead>
            <tbody id="places-body"></tbody>
        </table>
    </div>

    <script>
        // Initialize variables
        let $mygps = { lat: null, lon: null };
        let $cityname = '';
        let $city = { lat: null, lon: null };
        let $places = [];

        // Haversine formula to calculate distance between two points in miles
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Update status message
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Update location info
        function updateLocationInfo() {
            document.getElementById('location-info').innerHTML = `
                <p><strong>Your Location:</strong> (${$mygps.lat}, ${$mygps.lon})</p>
                <p><strong>Nearest City:</strong> ${$cityname} (${$city.lat}, ${$city.lon})</p>
            `;
        }

        // Populate the places table
        function populateTable() {
            const tbody = document.getElementById('places-body');
            tbody.innerHTML = '';
            $places.forEach(place => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${place.lat.toFixed(6)}</td>
                    <td class="border p-2">${place.lon.toFixed(6)}</td>
                    <td class="border p-2">${place.description}</td>
                    <td class="border p-2">${place.distance.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('places-table').classList.remove('hidden');
        }

        // Get user's GPS coordinates
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject('Geolocation is not supported by your browser');
                }
                navigator.geolocation.getCurrentPosition(
                    position => {
                        $mygps.lat = position.coords.latitude;
                        $mygps.lon = position.coords.longitude;
                        resolve();
                    },
                    error => reject('Unable to retrieve your location: ' + error.message)
                );
            });
        }

        // Nominatim reverse geocoding to find nearest city
        async function getNearestCity(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;
            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'NearestPlacesFinder/1.0' }
                });
                const data = await response.json();
                let city = data.address.city || data.address.town || data.address.village || 'Unknown';
                if (city === 'Unknown') {
                    // Fallback: Search for nearby cities
                    const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=place=city&limit=1&bounded=1&viewbox=${lon-0.5},${lat-0.5},${lon+0.5},${lat+0.5}`;
                    const searchResponse = await fetch(searchUrl, {
                        headers: { 'User-Agent': 'NearestPlacesFinder/1.0' }
                    });
                    const searchData = await searchResponse.json();
                    city = searchData[0]?.display_name.split(',')[0] || 'Unknown City';
                }
                return city;
            } catch (error) {
                throw new Error('Error fetching city: ' + error.message);
            }
        }

        // Nominatim forward geocoding to get city coordinates
        async function getCityCoordinates(city) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1&addressdetails=1`;
            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'NearestPlacesFinder/1.0' }
                });
                const data = await response.json();
                if (data.length === 0) throw new Error('City not found');
                return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
            } catch (error) {
                throw new Error('Error fetching city coordinates: ' + error.message);
            }
        }

        // Nominatim search for nearest 8 places
        async function getNearestPlaces(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&limit=8&bounded=1&viewbox=${lon-0.5},${lat-0.5},${lon+0.5},${lat+0.5}&q=*`;
            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'NearestPlacesFinder/1.0' }
                });
                const data = await response.json();
                return data.map(item => ({
                    lat: parseFloat(item.lat),
                    lon: parseFloat(item.lon),
                    description: item.display_name,
                    distance: haversineDistance(lat, lon, parseFloat(item.lat), parseFloat(item.lon))
                }));
            } catch (error) {
                throw new Error('Error fetching places: ' + error.message);
            }
        }

        // Main function to execute the workflow
        async function main() {
            try {
                // Step 1: Get user's location
                updateStatus('Retrieving your location...');
                await getUserLocation();

                // Step 2: Get nearest city
                updateStatus('Finding nearest city...');
                $cityname = await getNearestCity($mygps.lat, $mygps.lon);

                // Step 3: Get city coordinates
                updateStatus('Retrieving city coordinates...');
                $city = await getCityCoordinates($cityname);

                // Step 4: Get nearest 8 places
                updateStatus('Finding nearby places...');
                $places = await getNearestPlaces($mygps.lat, $mygps.lon);

                // Step 5: Update UI
                updateStatus('Done!');
                updateLocationInfo();
                populateTable();
            } catch (error) {
                updateStatus('Error: ' + error);
            }
        }

        // Run the main function
        main();
    </script>
</body>
</html>