<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Places to See</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 60vh; width: 100%; }
        #controls { padding: 10px; text-align: center; }
        #loading { display: none; text-align: center; font-size: 1.2em; color: #333; }
        select { padding: 8px; font-size: 1em; margin-bottom: 10px; }
        @media (max-width: 600px) {
            #map { height: 50vh; }
            select { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="controls">
        <h1 id="map-title">Places to See in Unknown</h1>
        <select id="place-type" onchange="fetchPlaces()">
            <option value="tourism=attraction">Tourist Attraction</option>
            <option value="amenity=cafe">Cafe</option>
            <option value="highway=bus_stop">Bus Stop</option>
            <option value="amenity=bus_station">Bus Station</option>
            <option value="historic=castle">Castle</option>
        </select>
    </div>
    <div id="loading">Please Wait</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let mygps = { lat: 40.7128, lon: -74.0060 }; // Fallback location
        let cityname = "Unknown";
        let city = { lat: 40.7128, lon: -74.0060 };
        let places = [];
        let map, myMarker;

        // Haversine formula to calculate distance in miles
        function haversineDistance(coord1, coord2) {
            const R = 3958.8; // Earth radius in miles
            const rad = Math.PI / 180;
            const dLat = (coord2.lat - coord1.lat) * rad;
            const dLon = (coord2.lon - coord1.lon) * rad;
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(coord1.lat * rad) * Math.cos(coord2.lat * rad) *
                      Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([mygps.lat, mygps.lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
        }

        // Add or update marker for mygps
        function updateMyMarker() {
            if (myMarker) myMarker.remove();
            const distance = haversineDistance(mygps, city).toFixed(2);
            myMarker = L.marker([mygps.lat, mygps.lon])
                .addTo(map)
                .bindPopup(`My Location<br>${distance} miles from ${cityname}`);
        }

        // Get current location
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        mygps = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        getNearestCity();
                    },
                    () => {
                        console.log("Geolocation denied, using fallback");
                        getNearestCity();
                    }
                );
            } else {
                console.log("Geolocation not supported, using fallback");
                getNearestCity();
            }
        }

        // Get nearest city using Nominatim reverse geocoding
        async function getNearestCity() {
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${mygps.lat}&lon=${mygps.lon}&addressdetails=1`;
                const response = await fetch(url, { headers: { 'User-Agent': 'PlacesToSee/1.0' } });
                const data = await response.json();
                cityname = data.address.city || data.address.town || data.address.village || "Unknown";
                if (cityname === "Unknown") {
                    // Fallback to broader search if city is unknown
                    const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=nearby+city&lat=${mygps.lat}&lon=${mygps.lon}&limit=1`;
                    const searchResponse = await fetch(searchUrl, { headers: { 'User-Agent': 'PlacesToSee/1.0' } });
                    const searchData = await searchResponse.json();
                    cityname = searchData[0]?.display_name.split(',')[0] || "Unknown City";
                }
                // Get city coordinates
                const cityUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityname)}&limit=1`;
                const cityResponse = await fetch(cityUrl, { headers: { 'User-Agent': 'PlacesToSee/1.0' } });
                const cityData = await cityResponse.json();
                if (cityData[0]) {
                    city = { lat: parseFloat(cityData[0].lat), lon: parseFloat(cityData[0].lon) };
                }
                document.getElementById('map-title').textContent = `Places to See in ${cityname}`;
                initMap();
                updateMyMarker();
                fetchPlaces();
            } catch (error) {
                console.error("Error fetching city:", error);
                document.getElementById('map-title').textContent = `Places to See in ${cityname}`;
                initMap();
                updateMyMarker();
                fetchPlaces();
            }
        }

        // Fetch places based on dropdown selection
        async function fetchPlaces() {
            const dropdown = document.getElementById('place-type').value;
            document.getElementById('loading').style.display = 'block';
            places = [];
            
            try {
                // Use Nominatim search with bounding box for nearby places
                const bboxSize = 0.1; // Approx 11km at equator
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${dropdown}&lat=${mygps.lat}&lon=${mygps.lon}&bounded=1&viewbox=${mygps.lon - bboxSize},${mygps.lat + bboxSize},${mygps.lon + bboxSize},${mygps.lat - bboxSize}&limit=8`;
                const response = await fetch(url, { headers: { 'User-Agent': 'PlacesToSee/1.0' } });
                const data = await response.json();

                for (let place of data) {
                    let description = place.display_name.split(',')[0] || "Unnamed";
                    if (description === "Unnamed") {
                        // Fallback to broader search for description
                        const detailUrl = `https://nominatim.openstreetmap.org/details?place_id=${place.place_id}&format=json`;
                        const detailResponse = await fetch(detailUrl, { headers: { 'User-Agent': 'PlacesToSee/1.0' } });
                        const detailData = await detailResponse.json();
                        description = detailData.names?.name || detailData.names?.alt_name || "Unknown Place";
                    }
                    const coords = { lat: parseFloat(place.lat), lon: parseFloat(place.lon) };
                    const distance = haversineDistance(mygps, coords).toFixed(2);
                    places.push({ description, coords, distance });
                }

                // Clear existing place markers
                map.eachLayer(layer => {
                    if (layer !== myMarker && layer instanceof L.Marker) layer.remove();
                });

                // Add markers for places
                places.forEach(place => {
                    L.marker([place.coords.lat, place.coords.lon])
                        .addTo(map)
                        .bindPopup(`${place.description}<br>${place.distance} miles from My Location`);
                });

            } catch (error) {
                console.error("Error fetching places:", error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Start the process
        getLocation();
    </script>
</body>
</html>