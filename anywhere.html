<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nearest City and Attractions</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Step 1: Get GPS Coordinates
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject("Geolocation is not supported by your browser.");
                } else {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve(position.coords),
                        (error) => reject(error.message)
                    );
                }
            });
        }

        // Step 2: Reverse Geocode to Find Nearest City
        async function getNearestCity(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.address.city || data.address.town || data.address.village;
        }

        // Step 3: Fetch Top Attractions Near the City
        async function getTopAttractions(city) {
            const url = `https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&format=json&limit=5&addressdetails=1&extratags=1&namedetails=1`;
            const response = await fetch(url);
            const data = await response.json();
            return data.filter(item => item.extratags && item.extratags.tourism).slice(0, 1); // Get the first attraction
        }

        // Step 4: Calculate Distance Between Two GPS Coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distanceKm = R * c;
            return distanceKm * 0.621371; // Convert to miles
        }

        // Main Function
        async function main() {
            try {
                // Get User Location
                const coords = await getUserLocation();
                const userLat = coords.latitude;
                const userLon = coords.longitude;

                // Find Nearest City
                const city = await getNearestCity(userLat, userLon);
                console.log(`Nearest City: ${city}`);

                // Initialize Map
                const map = L.map('map').setView([userLat, userLon], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                // Add Marker for User Location
                L.marker([userLat, userLon]).addTo(map)
                    .bindPopup("Your Location").openPopup();

                // Add Marker for City Center
                const cityResponse = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&format=json`);
                const cityData = await cityResponse.json();
                const cityLat = parseFloat(cityData[0].lat);
                const cityLon = parseFloat(cityData[0].lon);
                L.marker([cityLat, cityLon]).addTo(map)
                    .bindPopup(`Center of ${city}`).openPopup();

                // Fetch Top Attractions
                const attractions = await getTopAttractions(city);
                if (attractions.length > 0) {
                    const attraction = attractions[0];
                    const attractionLat = parseFloat(attraction.lat);
                    const attractionLon = parseFloat(attraction.lon);
                    const distanceMiles = calculateDistance(userLat, userLon, attractionLat, attractionLon).toFixed(2);

                    // Add Marker for First Attraction
                    L.marker([attractionLat, attractionLon]).addTo(map)
                        .bindPopup(`${attraction.display_name}<br>${distanceMiles} miles from your location`).openPopup();
                } else {
                    console.log("No attractions found.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        // Run the Application
        main();
    </script>
</body>
</html>