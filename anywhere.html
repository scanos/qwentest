<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>My Location Tracker</h1>
    <div id="map"></div>
    <p id="error-message" class="error"></p>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let mygps = null; // Variable to store current GPS coordinates
        const xplaces = []; // Array to store top attractions with distances

        // Initialize the map
        const map = L.map('map').setView([0, 0], 2); // Default view at world center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        // Function to calculate distance between two points in miles
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Earth's radius in miles
            const φ1 = (lat1 * Math.PI) / 180;
            const φ2 = (lat2 * Math.PI) / 180;
            const Δφ = ((lat2 - lat1) * Math.PI) / 180;
            const Δλ = ((lon2 - lon1) * Math.PI) / 180;

            const a =
                Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Function to get user's current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        mygps = [position.coords.latitude, position.coords.longitude];
                        updateMapAndPlaces();
                    },
                    () => {
                        showError("Geolocation failed. Please enter your location manually.");
                    }
                );
            } else {
                showError("Geolocation is not supported by this browser.");
            }
        }

        // Function to show error message and manual input box
        function showError(message) {
            document.getElementById('error-message').innerText = message;
            const manualInputLat = prompt("Enter latitude:");
            const manualInputLng = prompt("Enter longitude:");
            if (manualInputLat && manualInputLng) {
                mygps = [parseFloat(manualInputLat), parseFloat(manualInputLng)];
                updateMapAndPlaces();
            }
        }

        // Function to update map and places
        function updateMapAndPlaces() {
            if (!mygps) return;

            // Clear previous markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });

            // Add marker for mygps
            L.marker(mygps).addTo(map).bindPopup("Your Location").openPopup();
            map.setView(mygps, 13);

            // Populate xplaces with mock attractions near mygps
            populateXPlaces();

            // Calculate distances and sort xplaces
            for (let i = 0; i < xplaces.length - 1; i++) {
                const distance = calculateDistance(
                    xplaces[i].lat,
                    xplaces[i].lng,
                    xplaces[i + 1].lat,
                    xplaces[i + 1].lng
                );
                xplaces[i].distance = distance;
            }
            xplaces.sort((a, b) => a.distance - b.distance);

            // Find closest place to mygps
            let closestPlace = null;
            let minDistance = Infinity;
            for (const place of xplaces) {
                const distance = calculateDistance(mygps[0], mygps[1], place.lat, place.lng);
                place.distanceFromMygps = distance;
                if (distance < minDistance) {
                    minDistance = distance;
                    closestPlace = place;
                }
            }

            // Add marker for closest place
            if (closestPlace) {
                L.marker([closestPlace.lat, closestPlace.lng])
                    .addTo(map)
                    .bindPopup(`Closest Attraction (${minDistance.toFixed(2)} miles away)`);
            }
        }

        // Function to populate xplaces with mock attractions
        function populateXPlaces() {
            xplaces.push(
                { name: "Attraction 1", lat: mygps[0] + 0.01, lng: mygps[1] + 0.01 },
                { name: "Attraction 2", lat: mygps[0] - 0.02, lng: mygps[1] - 0.02 },
                { name: "Attraction 3", lat: mygps[0] + 0.03, lng: mygps[1] - 0.03 },
                { name: "Attraction 4", lat: mygps[0] - 0.04, lng: mygps[1] + 0.04 },
                { name: "Attraction 5", lat: mygps[0] + 0.05, lng: mygps[1] + 0.05 },
                { name: "Attraction 6", lat: mygps[0] - 0.06, lng: mygps[1] - 0.06 },
                { name: "Attraction 7", lat: mygps[0] + 0.07, lng: mygps[1] - 0.07 },
                { name: "Attraction 8", lat: mygps[0] - 0.08, lng: mygps[1] + 0.08 },
                { name: "Attraction 9", lat: mygps[0] + 0.09, lng: mygps[1] + 0.09 },
                { name: "Attraction 10", lat: mygps[0] - 0.1, lng: mygps[1] - 0.1 }
            );
        }

        // Event listener for marker click on mygps
        map.on('click', (e) => {
            mygps = [e.latlng.lat, e.latlng.lng];
            updateMapAndPlaces();
        });

        // Start the process
        getCurrentLocation();
    </script>
</body>
</html>