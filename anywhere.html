<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nearest Places Finder</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div id="container" class="bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full">
    <h1 class="text-2xl font-bold mb-4 text-center">Nearby Places</h1>
    <div id="loading" class="text-center text-gray-600">Please Wait</div>
    <div id="content" class="hidden">
      <p id="user-location" class="mb-2"></p>
      <p id="city-info" class="mb-4"></p>
      <table id="places-table" class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200">
            <th class="border p-2">Description</th>
            <th class="border p-2">Latitude</th>
            <th class="border p-2">Longitude</th>
            <th class="border p-2">Distance (miles)</th>
          </tr>
        </thead>
        <tbody id="places-tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Variables to store data
    let $mygps = { lat: 0, lng: 0 };
    let $cityname = "";
    let $city = { lat: 0, lng: 0 };
    let $places = [];

    // Haversine formula to calculate distance between two points in miles
    function haversineDistance(coord1, coord2) {
      const R = 3958.8; // Earth's radius in miles
      const toRad = (deg) => deg * Math.PI / 180;
      const dLat = toRad(coord2.lat - coord1.lat);
      const dLng = toRad(coord2.lng - coord1.lng);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(coord1.lat)) * Math.cos(toRad(coord2.lat)) * Math.sin(dLng / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Show loading message
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('content').classList.add('hidden');
    }

    // Hide loading message and show content
    function showContent() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    }

    // Get user's GPS coordinates
    function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              $mygps = { lat: position.coords.latitude, lng: position.coords.longitude };
              resolve($mygps);
            },
            (error) => reject("Geolocation error: " + error.message)
          );
        } else {
          reject("Geolocation is not supported by this browser.");
        }
      });
    }

    // Reverse geocode to find nearest city
    async function getNearestCity(coords) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}&zoom=10`
        );
        const data = await response.json();
        $cityname = data.address.city || data.address.town || data.address.village || "Unknown";
        $city = { lat: parseFloat(data.lat), lng: parseFloat(data.lon) };
        if ($cityname === "Unknown") {
          // Fallback to GeoNames for a valid city
          const geoNamesResponse = await fetch(
            `http://api.geonames.org/findNearbyPlaceNameJSON?lat=${coords.lat}&lng=${coords.lng}&username=demo`
          );
          const geoNamesData = await geoNamesResponse.json();
          if (geoNamesData.geonames && geoNamesData.geonames.length > 0) {
            $cityname = geoNamesData.geonames[0].name;
            $city = { lat: parseFloat(geoNamesData.geonames[0].lat), lng: parseFloat(geoNamesData.geonames[0].lng) };
          }
        }
        return { cityname: $cityname, city: $city };
      } catch (error) {
        console.error("Error fetching city:", error);
        return { cityname: "Unknown", city: { lat: 0, lng: 0 } };
      }
    }

    // Fetch 8 nearest places from GeoNames
    async function getNearestPlaces(coords) {
      try {
        const response = await fetch(
          `http://api.geonames.org/findNearbyJSON?lat=${coords.lat}&lng=${coords.lng}&featureClass=P&maxRows=8&username=demo`
        );
        const data = await response.json();
        $places = data.geonames.map(place => ({
          description: place.name + (place.adminName1 ? ", " + place.adminName1 : ""),
          lat: parseFloat(place.lat),
          lng: parseFloat(place.lng),
          distance: 0 // Will be calculated later
        }));
        // Calculate distances
        $places.forEach(place => {
          place.distance = haversineDistance(coords, { lat: place.lat, lng: place.lng }).toFixed(2);
        });
        return $places;
      } catch (error) {
        console.error("Error fetching places:", error);
        return [];
      }
    }

    // Render the table with places
    function renderTable() {
      const tbody = document.getElementById('places-tbody');
      tbody.innerHTML = '';
      $places.forEach(place => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="border p-2">${place.description}</td>
          <td class="border p-2">${place.lat.toFixed(4)}</td>
          <td class="border p-2">${place.lng.toFixed(4)}</td>
          <td class="border p-2">${place.distance}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Main function to orchestrate the process
    async function main() {
      showLoading();
      try {
        // Step 1: Get user's location
        await getUserLocation();
        document.getElementById('user-location').textContent = 
          `Your Location: Latitude ${$mygps.lat.toFixed(4)}, Longitude ${$mygps.lng.toFixed(4)}`;

        // Step 2: Get nearest city
        const cityInfo = await getNearestCity($mygps);
        document.getElementById('city-info').textContent = 
          `Nearest City: ${$cityname} (Latitude ${$city.lat.toFixed(4)}, Longitude ${$city.lng.toFixed(4)})`;

        // Step 3: Get nearest places
        await getNearestPlaces($mygps);

        // Step 4: Render results
        renderTable();
        showContent();
      } catch (error) {
        document.getElementById('loading').textContent = "Error: " + error;
        console.error(error);
      }
    }

    // Start the process
    main();
  </script>
</body>
</html>